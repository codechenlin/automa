From 627644861ff281add11773a1493dbbfe2bb4b328 Mon Sep 17 00:00:00 2001
From: Muahd1b <kjbusines006@gmail.com>
Date: Wed, 18 Feb 2026 18:29:56 +0100
Subject: [PATCH] fix: harden skill bin checks and heartbeat scheduling

---
 src/agent/tools.ts      | 13 +++++++++--
 src/heartbeat/daemon.ts | 49 +++++++++++++++++++++++++++++------------
 src/skills/loader.ts    | 13 +++++++----
 3 files changed, 55 insertions(+), 20 deletions(-)

diff --git a/src/agent/tools.ts b/src/agent/tools.ts
index 60dedac..a8a70ff 100644
--- a/src/agent/tools.ts
+++ b/src/agent/tools.ts
@@ -64,6 +64,8 @@ function isForbiddenCommand(command: string, sandboxId: string): string | null {
   return null;
 }
 
+const COMMIT_HASH_PATTERN = /^[a-f0-9]{7,40}$/i;
+
 // ─── Built-in Tools ────────────────────────────────────────────
 
 export function createBuiltinTools(sandboxId: string): AutomatonTool[] {
@@ -390,7 +392,7 @@ export function createBuiltinTools(sandboxId: string): AutomatonTool[] {
         },
       },
       execute: async (args, ctx) => {
-        const { execSync } = await import("child_process");
+        const { execSync, execFileSync } = await import("child_process");
         const cwd = process.cwd();
         const commit = args.commit as string | undefined;
 
@@ -400,7 +402,14 @@ export function createBuiltinTools(sandboxId: string): AutomatonTool[] {
         let appliedSummary: string;
         try {
           if (commit) {
-            run(`git cherry-pick ${commit}`);
+            if (!COMMIT_HASH_PATTERN.test(commit)) {
+              return `Invalid commit hash: '${commit}'. Expected 7-40 hex characters.`;
+            }
+            execFileSync("git", ["cherry-pick", commit], {
+              cwd,
+              encoding: "utf-8",
+              timeout: 120_000,
+            });
             appliedSummary = `Cherry-picked ${commit}`;
           } else {
             run("git pull origin main --ff-only");
diff --git a/src/heartbeat/daemon.ts b/src/heartbeat/daemon.ts
index 76a2b18..71b7853 100644
--- a/src/heartbeat/daemon.ts
+++ b/src/heartbeat/daemon.ts
@@ -17,6 +17,7 @@ import type {
 } from "../types.js";
 import { BUILTIN_TASKS, type HeartbeatTaskContext } from "./tasks.js";
 import { getSurvivalTier } from "../conway/credits.js";
+import { loadHeartbeatConfig } from "./config.js";
 
 export interface HeartbeatDaemonOptions {
   identity: AutomatonIdentity;
@@ -41,8 +42,11 @@ export function createHeartbeatDaemon(
   options: HeartbeatDaemonOptions,
 ): HeartbeatDaemon {
   const { identity, config, db, conway, social, onWakeRequest } = options;
-  let intervalId: ReturnType<typeof setInterval> | null = null;
+  let intervalId: ReturnType<typeof setTimeout> | null = null;
   let running = false;
+  const heartbeatConfig = loadHeartbeatConfig(config.heartbeatConfigPath);
+  const baseTickMs = Math.max(1_000, heartbeatConfig.defaultIntervalMs || 60_000);
+  const lowComputeMultiplier = Math.max(1, heartbeatConfig.lowComputeMultiplier || 1);
 
   const taskContext: HeartbeatTaskContext = {
     identity,
@@ -107,7 +111,7 @@ export function createHeartbeatDaemon(
   /**
    * The main tick function. Runs on every interval.
    */
-  async function tick(): Promise<void> {
+  async function tick(): Promise<boolean> {
     const entries = db.getHeartbeatEntries();
 
     // Check survival tier to adjust behavior
@@ -137,6 +141,26 @@ export function createHeartbeatDaemon(
         await executeTask(entry);
       }
     }
+
+    return isLowCompute;
+  }
+
+  function scheduleNextTick(isLowCompute: boolean): void {
+    const nextTickMs = isLowCompute
+      ? Math.round(baseTickMs * lowComputeMultiplier)
+      : baseTickMs;
+
+    intervalId = setTimeout(() => {
+      tick()
+        .then((nextIsLowCompute) => {
+          if (!running) return;
+          scheduleNextTick(nextIsLowCompute);
+        })
+        .catch((err) => {
+          console.error(`[HEARTBEAT] Tick failed: ${err.message}`);
+          if (running) scheduleNextTick(false);
+        });
+    }, nextTickMs);
   }
 
   // ─── Public API ──────────────────────────────────────────────
@@ -145,22 +169,19 @@ export function createHeartbeatDaemon(
     if (running) return;
     running = true;
 
-    // Get tick interval -- default 60 seconds
-    const tickMs = config.logLevel === "debug" ? 15_000 : 60_000;
-
     // Run first tick immediately
-    tick().catch((err) => {
-      console.error(`[HEARTBEAT] First tick failed: ${err.message}`);
-    });
-
-    intervalId = setInterval(() => {
-      tick().catch((err) => {
+    tick()
+      .then((isLowCompute) => {
+        if (!running) return;
+        scheduleNextTick(isLowCompute);
+      })
+      .catch((err) => {
         console.error(`[HEARTBEAT] Tick failed: ${err.message}`);
+        if (running) scheduleNextTick(false);
       });
-    }, tickMs);
 
     console.log(
-      `[HEARTBEAT] Daemon started. Tick interval: ${tickMs / 1000}s`,
+      `[HEARTBEAT] Daemon started. Tick interval: ${baseTickMs / 1000}s (low-compute multiplier: ${lowComputeMultiplier}x)`,
     );
   };
 
@@ -168,7 +189,7 @@ export function createHeartbeatDaemon(
     if (!running) return;
     running = false;
     if (intervalId) {
-      clearInterval(intervalId);
+      clearTimeout(intervalId);
       intervalId = null;
     }
     console.log("[HEARTBEAT] Daemon stopped.");
diff --git a/src/skills/loader.ts b/src/skills/loader.ts
index f5606e5..f24d3ab 100644
--- a/src/skills/loader.ts
+++ b/src/skills/loader.ts
@@ -8,9 +8,12 @@
 
 import fs from "fs";
 import path from "path";
+import { spawnSync } from "child_process";
 import type { Skill, AutomatonDatabase } from "../types.js";
 import { parseSkillMd } from "./format.js";
 
+const SAFE_BIN_NAME = /^[A-Za-z0-9._-]+$/;
+
 /**
  * Scan the skills directory and load all valid SKILL.md files.
  * Returns loaded skills and syncs them to the database.
@@ -71,10 +74,12 @@ function checkRequirements(skill: Skill): boolean {
   // Check required binaries
   if (skill.requires.bins) {
     for (const bin of skill.requires.bins) {
-      try {
-        const { execSync } = require("child_process");
-        execSync(`which ${bin}`, { stdio: "ignore" });
-      } catch {
+      if (!SAFE_BIN_NAME.test(bin)) {
+        return false;
+      }
+
+      const result = spawnSync("which", [bin], { stdio: "ignore" });
+      if (result.status !== 0) {
         return false;
       }
     }
-- 
2.50.1 (Apple Git-155)

